<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Dynamic Range Bars</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
        }
        
        .chart-container {
            background: rgba(22, 33, 62, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .bars-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            height: 400px;
            align-items: end;
            position: relative;
            border-bottom: 2px solid #374151;
            border-left: 2px solid #374151;
            padding: 20px 10px 0 40px;
        }
        
        .bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            min-width: 0;
        }
        
        .bar {
            width: 100%;
            max-width: 40px;
            position: relative;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        }
        
        .bar-current {
            width: 100%;
            max-width: 40px;
            position: relative;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
            100% { opacity: 0.7; transform: scale(1); }
        }
        
        .day-label {
            position: absolute;
            bottom: -30px;
            font-size: 12px;
            font-weight: 600;
            color: #9CA3AF;
            width: 100%;
            text-align: center;
        }
        
        .price-labels {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 35px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-end;
            padding-right: 5px;
        }
        
        .price-label {
            font-size: 10px;
            color: #6B7280;
            font-weight: 500;
            text-align: right;
            line-height: 1;
            position: absolute;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 11px;
            z-index: 100;
            pointer-events: none;
            white-space: nowrap;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        
        .volume-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            height: 80px;
            margin-top: 15px;
            position: relative;
            border-left: 2px solid #374151;
            align-items: flex-end;
            padding: 0 10px 0 40px;
        }
        
        .volume-bar {
            width: 100%;
            max-width: 40px;
            position: relative;
            border-radius: 2px;
            transition: all 0.3s ease;
            justify-self: center;
        }
        
        .volume-bar:hover {
            transform: translateY(-1px);
        }
        
        /* Cross gauge styles */
        .cross-gauge {
            position: absolute;
            pointer-events: none;
            z-index: 50;
            display: none;
        }
        
        .cross-gauge-line {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .cross-gauge-horizontal {
            height: 1px;
            width: 100%;
            left: 0;
        }
        
        .cross-gauge-vertical {
            width: 1px;
            height: 100%;
            top: 0;
        }
        
        .cross-gauge-price {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
        }
        
        /* Crypto selector styles */
        .crypto-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .crypto-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .crypto-btn.active {
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btc-btn { background-color: #f7931a; color: #111; }
        .eth-btn { background-color: #627eea; color: white; }
        .sol-btn { background-color: #00ffbd; color: #111; }
        .ada-btn { background-color: #0033ad; color: white; }
        .bnb-btn { background-color: #f3ba2f; color: #111; }
        
        @media (max-width: 768px) {
            .bars-container {
                height: 300px;
                padding: 15px 5px 0 30px;
                gap: 4px;
            }
            
            .volume-container {
                height: 60px;
                padding: 0 5px 0 30px;
                gap: 4px;
            }
            
            .price-labels {
                width: 25px;
            }
            
            .price-label {
                font-size: 9px;
            }
            
            .day-label {
                font-size: 11px;
                bottom: -25px;
            }
            
            .crypto-btn {
                padding: 6px 12px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 640px) {
            .bars-container {
                height: 250px;
                padding: 10px 3px 0 25px;
                gap: 2px;
            }
            
            .volume-container {
                height: 50px;
                padding: 0 3px 0 25px;
                gap: 2px;
            }
            
            .price-labels {
                width: 20px;
            }
            
            .price-label {
                font-size: 8px;
            }
            
            .crypto-btn {
                padding: 4px 8px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body class="text-gray-100">
    <div class="container mx-auto px-4 py-6">
        <div class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-yellow-400 mb-2">
                Crypto Dynamic Range Bars
            </h1>
            <div class="text-gray-400 text-sm md:text-base">
                Real-time price range bars (High â†’ Low) with historical comparison
            </div>
        </div>
        
        <div class="flex flex-col items-center mb-6">
            <div class="crypto-selector mb-4">
                <button class="crypto-btn btc-btn active" data-crypto="BTC">
                    <i class="fab fa-bitcoin mr-1"></i> Bitcoin
                </button>
                <button class="crypto-btn eth-btn" data-crypto="ETH">
                    <i class="fab fa-ethereum mr-1"></i> Ethereum
                </button>
                <button class="crypto-btn sol-btn" data-crypto="SOL">
                    <i class="fas fa-chart-line mr-1"></i> Solana
                </button>
                <button class="crypto-btn ada-btn" data-crypto="ADA">
                    <i class="fas fa-coins mr-1"></i> Cardano
                </button>
                <button class="crypto-btn bnb-btn" data-crypto="BNB">
                    <i class="fas fa-wallet mr-1"></i> BNB
                </button>
            </div>
            
            <div class="flex flex-col md:flex-row items-center justify-center gap-4">
                <button id="refresh-btn" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-2 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i>
                    Refresh Data
                </button>
                <span id="last-updated" class="text-gray-400 text-sm"></span>
            </div>
        </div>
        
        <div class="chart-container rounded-2xl p-4 md:p-6 shadow-2xl mx-auto max-w-6xl">
            <div class="flex justify-between items-center mb-4">
                <div class="text-gray-300 text-sm font-medium">
                    <span id="current-crypto">Bitcoin</span> 7-Day Range Chart
                </div>
                <div id="time-display" class="text-xs text-gray-400 font-mono"></div>
            </div>
            
            <div class="bars-container" id="chart">
                <div class="col-span-7 flex items-center justify-center text-yellow-400 text-lg" id="loading">
                    <i class="fas fa-spinner fa-spin mr-2"></i>
                    Loading Bitcoin data...
                </div>
            </div>
            
            <div class="text-gray-500 text-xs mt-2 ml-10">
                Volume (<span id="volume-unit">BTC</span>)
            </div>
            <div class="volume-container" id="volume-chart"></div>
        </div>
        
        <div class="bg-black bg-opacity-30 rounded-xl p-4 md:p-6 mt-6 max-w-4xl mx-auto backdrop-filter backdrop-blur-sm border border-gray-700">
            <p class="text-sm leading-relaxed mb-3">
                <span class="text-yellow-400 font-semibold">How to read this chart:</span> 
                Each bar represents a day's price range from High (top) to Low (bottom). 
                <span class="text-green-400 font-medium">Green</span> bars indicate the close price is in the upper half of the day's range, 
                <span class="text-red-400 font-medium">red</span> bars indicate it's in the lower half.
                <span class="text-blue-400 font-medium">Move your cursor over the chart to see the cross gauge.</span>
            </p>
            <p class="text-xs text-gray-400">
                Hover over bars to see price details. Data refreshes on page load - click "Refresh Data" for updates.
            </p>
        </div>
    </div>

    <script>
        // Global variables
        let historicalData = [];
        let currentDayData = null;
        let currentPrice = 0;
        let chartHeight = 400;
        let currentCrypto = 'BTC';
        let minPrice = 0;
        let maxPrice = 0;
        let priceRange = 1;
        
        // Crypto information
        const cryptoInfo = {
            'BTC': { name: 'Bitcoin', symbol: 'BTC', icon: 'fab fa-bitcoin', volumeUnit: 'BTC' },
            'ETH': { name: 'Ethereum', symbol: 'ETH', icon: 'fab fa-ethereum', volumeUnit: 'ETH' },
            'SOL': { name: 'Solana', symbol: 'SOL', icon: 'fas fa-chart-line', volumeUnit: 'SOL' },
            'ADA': { name: 'Cardano', symbol: 'ADA', icon: 'fas fa-coins', volumeUnit: 'ADA' },
            'BNB': { name: 'BNB', symbol: 'BNB', icon: 'fas fa-wallet', volumeUnit: 'BNB' }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            updateChartHeight();
            fetchHistoricalData();
            
            // Set up event listeners
            document.getElementById('refresh-btn').addEventListener('click', fetchHistoricalData);
            setInterval(updateTimeDisplay, 1000);
            window.addEventListener('resize', updateChartHeight);
            
            // Set up crypto selector buttons
            document.querySelectorAll('.crypto-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    document.querySelectorAll('.crypto-btn').forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Update current crypto
                    currentCrypto = this.dataset.crypto;
                    document.getElementById('current-crypto').textContent = cryptoInfo[currentCrypto].name;
                    document.getElementById('volume-unit').textContent = cryptoInfo[currentCrypto].volumeUnit;
                    
                    // Fetch new data
                    fetchHistoricalData();
                });
            });
        });
        
        function updateChartHeight() {
            if (window.innerWidth < 640) {
                chartHeight = 250;
            } else if (window.innerWidth < 768) {
                chartHeight = 300;
            } else {
                chartHeight = 400;
            }
        }
        
        function updateTimeDisplay() {
            document.getElementById('time-display').textContent = new Date().toLocaleTimeString();
        }
        
        async function fetchHistoricalData() {
            const loadingElement = document.getElementById('loading');
            const lastUpdatedElement = document.getElementById('last-updated');
            
            try {
                loadingElement.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Loading ${cryptoInfo[currentCrypto].name} historical data...`;
                
                let dailyData = await fetchBinanceHistoricalData();
                
                if (!dailyData || dailyData.length < 7) {
                    loadingElement.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Binance unavailable, trying CoinGecko for ${cryptoInfo[currentCrypto].name}...`;
                    dailyData = await fetchCoinGeckoHistoricalData();
                }
                
                if (dailyData && dailyData.length >= 7) {
                    historicalData = processDataForWeekDisplay(dailyData);
                    processHistoricalData();
                    lastUpdatedElement.innerHTML = '<i class="fas fa-clock mr-1"></i>Last updated: ' + new Date().toLocaleTimeString();
                } else {
                    throw new Error("Insufficient data from both sources");
                }
            } catch (error) {
                loadingElement.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>Error loading ${cryptoInfo[currentCrypto].name} data: ${error.message}`;
                console.error(error);
            }
        }
        
        function processDataForWeekDisplay(data) {
            // Get the last 7 days of data in chronological order (oldest to newest)
            const last7Days = data.slice(-7);
            
            // Return the data in chronological order for display
            return last7Days;
        }
        
        async function fetchBinanceHistoricalData() {
            try {
                const symbol = currentCrypto === 'BTC' ? 'BTCUSDT' : `${currentCrypto}USDT`;
                const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&limit=7`);
                const data = await response.json();
                
                return data.map(item => ({
                    date: new Date(item[0]),
                    open: parseFloat(item[1]),
                    high: parseFloat(item[2]),
                    low: parseFloat(item[3]),
                    close: parseFloat(item[4]),
                    volume: parseFloat(item[5]),
                    isComplete: true
                }));
            } catch (error) {
                console.log("Binance historical fetch failed, trying CoinGecko");
                return null;
            }
        }
        
        async function fetchCoinGeckoHistoricalData() {
            try {
                const coinId = getCoinGeckoId(currentCrypto);
                const response = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=7`);
                const data = await response.json();
                
                if (!data.prices || data.prices.length < 7) return null;
                
                // Group prices by day
                const dailyPrices = {};
                data.prices.forEach(point => {
                    const date = new Date(point[0]);
                    const day = date.toISOString().split('T')[0];
                    if (!dailyPrices[day]) {
                        dailyPrices[day] = [];
                    }
                    dailyPrices[day].push(point[1]);
                });
                
                // Convert to daily OHLC data
                const dailyData = Object.keys(dailyPrices)
                    .sort()
                    .slice(-7)
                    .map(day => {
                        const prices = dailyPrices[day];
                        return {
                            date: new Date(day),
                            open: prices[0],
                            high: Math.max(...prices),
                            low: Math.min(...prices),
                            close: prices[prices.length - 1],
                            volume: 0, // CoinGecko doesn't provide volume in this endpoint
                            isComplete: true
                        };
                    });
                
                return dailyData;
            } catch (error) {
                console.log("CoinGecko historical fetch failed");
                return null;
            }
        }
        
        function getCoinGeckoId(crypto) {
            const ids = {
                'BTC': 'bitcoin',
                'ETH': 'ethereum',
                'SOL': 'solana',
                'ADA': 'cardano',
                'BNB': 'binancecoin'
            };
            return ids[crypto] || 'bitcoin';
        }
        
        function processHistoricalData() {
            // Set current price to the latest close price
            if (historicalData.length > 0) {
                currentPrice = historicalData[historicalData.length - 1].close;
            }
            
            renderChart();
        }
        
        function renderChart() {
            const chartElement = document.getElementById('chart');
            const volumeElement = document.getElementById('volume-chart');
            chartElement.innerHTML = '';
            volumeElement.innerHTML = '';
            
            if (historicalData.length === 0) return;
            
            // Calculate price range for all days
            const allHighs = historicalData.map(d => d.high);
            const allLows = historicalData.map(d => d.low);
            maxPrice = Math.max(...allHighs);
            minPrice = Math.min(...allLows);
            priceRange = maxPrice - minPrice || 1;
            
            // Calculate volume range (only for days with volume data)
            const volumes = historicalData.filter(d => d.volume > 0).map(d => d.volume);
            const maxVolume = volumes.length > 0 ? Math.max(...volumes) : 1;
            
            // Add price labels with proper alignment
            const priceLabels = document.createElement('div');
            priceLabels.className = 'price-labels';
            
            // Create 5 price labels evenly spaced
            for (let i = 0; i <= 4; i++) {
                const price = minPrice + (priceRange * i / 4);
                const label = document.createElement('div');
                label.className = 'price-label';
                label.textContent = '$' + price.toFixed(0);
                // Position from bottom, and adjust for vertical centering
                label.style.bottom = (i / 4) * 100 + '%'; 
                priceLabels.appendChild(label);
            }
            
            chartElement.appendChild(priceLabels);
            
            // Create cross gauge elements
            const crossGauge = document.createElement('div');
            crossGauge.className = 'cross-gauge';
            crossGauge.id = 'cross-gauge';
            crossGauge.style.display = 'none';
            
            const horizontalLine = document.createElement('div');
            horizontalLine.className = 'cross-gauge-line cross-gauge-horizontal';
            
            const verticalLine = document.createElement('div');
            verticalLine.className = 'cross-gauge-line cross-gauge-vertical';
            
            const priceLabel = document.createElement('div');
            priceLabel.className = 'cross-gauge-price';
            priceLabel.id = 'cross-price';
            
            crossGauge.appendChild(horizontalLine);
            crossGauge.appendChild(verticalLine);
            crossGauge.appendChild(priceLabel);
            
            chartElement.appendChild(crossGauge);
            
            // Day labels
            const dayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            historicalData.forEach((dayData, index) => {
                const barGroup = document.createElement('div');
                barGroup.className = 'bar-group';
                
                // Calculate positions
                const highPos = ((dayData.high - minPrice) / priceRange) * chartHeight;
                const lowPos = ((dayData.low - minPrice) / priceRange) * chartHeight;
                const barHeight = Math.max(2, highPos - lowPos);
                
                // Determine bar color based on close price position in range
                const rangeMiddle = (dayData.high + dayData.low) / 2;
                const barColor = dayData.close >= rangeMiddle ? '#10B981' : '#EF4444';
                
                // Create bar
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = barHeight + 'px';
                bar.style.marginBottom = lowPos + 'px'; // Position from bottom
                bar.style.backgroundColor = barColor;
                
                // Add event listeners for tooltips
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.style.display = 'none';
                
                bar.addEventListener('mouseenter', function(e) {
                    const dateStr = dayData.date.toLocaleDateString();
                    const dayName = dayLabels[(index) % 7];
                    let tooltipContent = `
                        <div class="font-semibold text-yellow-400">${dayName} (${dateStr})</div>
                        <div>High: $${dayData.high.toFixed(2)}</div>
                        <div>Low: $${dayData.low.toFixed(2)}</div>
                        <div>Open: $${dayData.open.toFixed(2)}</div>
                        <div>Close: $${dayData.close.toFixed(2)}</div>
                        <div>Range: $${(dayData.high - dayData.low).toFixed(2)}</div>
                    `;
                    
                    tooltip.innerHTML = tooltipContent;
                    tooltip.style.display = 'block';
                    tooltip.style.bottom = 'calc(100% + 5px)';
                    tooltip.style.left = '50%';
                    tooltip.style.transform = 'translateX(-50%)';
                });
                
                bar.addEventListener('mouseleave', function() {
                    tooltip.style.display = 'none';
                });
                
                barGroup.appendChild(bar);
                barGroup.appendChild(tooltip);
                
                // Add day label
                const dayLabel = document.createElement('div');
                dayLabel.className = 'day-label';
                dayLabel.textContent = dayLabels[index % 7];
                barGroup.appendChild(dayLabel);
                
                chartElement.appendChild(barGroup);
                
                // Add volume bar
                const volumeBar = document.createElement('div');
                volumeBar.className = 'volume-bar';
                
                // Always create a volume bar, even if volume is 0
                let volumeHeight;
                if (dayData.volume > 0) {
                    volumeHeight = (dayData.volume / maxVolume) * (window.innerWidth < 640 ? 40 : window.innerWidth < 768 ? 50 : 80);
                } else {
                    // Show a minimal bar for days without volume data
                    volumeHeight = 2;
                }
                
                volumeBar.style.height = volumeHeight + 'px';
                
                // Use same color logic as price bars
                const color = dayData.close >= rangeMiddle ? 'rgba(16, 185, 129, 0.4)' : 'rgba(239, 68, 68, 0.4)';
                volumeBar.style.backgroundColor = color;
                
                // Add volume tooltip
                const volumeTooltip = document.createElement('div');
                volumeTooltip.className = 'tooltip';
                volumeTooltip.style.display = 'none';
                
                const volumeText = dayData.volume > 0 ? 
                    `Volume: ${dayData.volume.toLocaleString()} ${cryptoInfo[currentCrypto].volumeUnit}` : 
                    'Volume: No data';
                volumeTooltip.innerHTML = `<div class="text-blue-400">${volumeText}</div>`;
                
                volumeBar.addEventListener('mouseenter', function() {
                    volumeTooltip.style.display = 'block';
                    volumeTooltip.style.bottom = (volumeHeight + 5) + 'px';
                    volumeTooltip.style.left = '50%';
                    volumeTooltip.style.transform = 'translateX(-50%)';
                });
                
                volumeBar.addEventListener('mouseleave', function() {
                    volumeTooltip.style.display = 'none';
                });
                
                const volumeGroup = document.createElement('div');
                volumeGroup.style.position = 'relative';
                volumeGroup.style.display = 'flex';
                volumeGroup.style.justifyContent = 'center';
                volumeGroup.appendChild(volumeBar);
                volumeGroup.appendChild(volumeTooltip);
                
                volumeElement.appendChild(volumeGroup);
            });
            
            // Set up cross gauge event listeners
            chartElement.addEventListener('mousemove', function(e) {
                const rect = chartElement.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Only show cross gauge if mouse is within the chart area (excluding labels)
                if (x >= 40 && x <= rect.width && y >= 0 && y <= chartHeight) {
                    crossGauge.style.display = 'block';
                    crossGauge.style.left = '0';
                    crossGauge.style.top = '0';
                    crossGauge.style.width = '100%';
                    crossGauge.style.height = '100%';
                    
                    // Update cross lines
                    horizontalLine.style.top = y + 'px';
                    horizontalLine.style.width = '100%';
                    horizontalLine.style.left = '0';
                    
                    verticalLine.style.left = x + 'px';
                    verticalLine.style.height = '100%';
                    verticalLine.style.top = '0';
                    
                    // Calculate and display price at cursor position
                    const priceAtCursor = maxPrice - ((y / chartHeight) * priceRange);
                    priceLabel.textContent = '$' + priceAtCursor.toFixed(2);
                    priceLabel.style.left = (x + 10) + 'px';
                    priceLabel.style.top = (y - 20) + 'px';
                } else {
                    crossGauge.style.display = 'none';
                }
            });
            
            chartElement.addEventListener('mouseleave', function() {
                crossGauge.style.display = 'none';
            });
        }
    </script>
</body>
</html>
